name: CI

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  lint-type-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: latest

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Sync dependencies (dev)
        run: uv sync --group dev

      - name: Lint (ruff)
        run: uv run ruff check .

      - name: Type check (mypy)
        run: uv run python -m mypy .

  # test:
  #   runs-on: ubuntu-latest
  #   needs: [lint-type-check]
  #   services:
  #     surrealdb:
  #       image: surrealdb/surrealdb:latest
  #       ports:
  #         - 8000:8000
  #       options: >-
  #         --health-cmd="/surreal isready -h 127.0.0.1:8000" --health-interval=5s --health-timeout=5s --health-retries=20
  #       env:
  #         SURREAL_LOG: info
  #   strategy:
  #     matrix:
  #       python-version: ["3.11", "3.12"]
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Install uv
  #       uses: astral-sh/setup-uv@v5
  #       with:
  #         version: latest

  #     - name: Set up Python ${{ matrix.python-version }}
  #       run: uv python install ${{ matrix.python-version }}

  #     - name: Sync dependencies (dev)
  #       run: uv sync --group dev

  #     - name: Run tests (pytest)
  #       env:
  #         SURREALDB_URL: http://127.0.0.1:8000
  #       run: uv run pytest -q --cov --cov-report=xml

  #     - name: Upload coverage (Codecov)
  #       if: matrix.python-version == '3.11'
  #       uses: codecov/codecov-action@v4
  #       with:
  #         files: ./coverage.xml
  #         flags: backend
  #         fail_ci_if_error: false
  #       env:
  #         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # test-status:
  #   runs-on: ubuntu-latest
  #   needs: [test]
  #   if: always()
  #   steps:
  #     - name: Check test results
  #       run: |
  #         if [ "${{ needs.test.result }}" != "success" ]; then
  #           echo "Tests failed!"
  #           exit 1
  #         fi
  #         echo "All tests passed!"
